<!DOCTYPE html>

<html>
<head>
	<meta charset="utf-8" />
	<title>Marauder's Map</title>
	<link rel="stylesheet" href="style.css" type="text/css" />
	<style type="text/css">
		html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
	</style>
	<script type="text/javascript"
		src="http://maps.googleapis.com/maps/api/js?sensor=true"></script>
	</script>
	<script type = "text/javascript">


		var lat = 0;
		var lng = 0;
		//var me = google.maps.LatLng(lat, lng);

		var mapOptions = {
			center: {lat: 42.4183, lng: -71.1067},
			zoom: 12,
		};

		var map;
		var markers = [];
		var infowindows = [];
		var characters = [];
		var students = [];

		google.maps.event.addDomListener(window, 'load', initialize);
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function() {

			if (xhr.readyState==4 && xhr.status==200) {
				console.log(xhr.responseText);
				var jsonResponse = JSON.parse(xhr.responseText);
				getCharacters(jsonResponse);
				getStudents(jsonResponse);

			}
		}


		function initialize() {
			map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
			getLocation();
		}
		
		function getLocation(){
		    if (navigator.geolocation) {
		    	navigator.geolocation.getCurrentPosition(function(position) {
				lat = position.coords.latitude;
				lng = position.coords.longitude;
				renderMap();

			}, 
		    	function() { alert("error")
		    },
		    	{timeout:10000}
		    );


		    } else {
		        alert("Geolocation is not supported by this browser.");
		    }
		}



		function renderMap() {
			me = new google.maps.LatLng(lat, lng);
			map.panTo(me);
		

			markers[0] = new google.maps.Marker({
				position: me,
				title: "i'm here"
			});
			//markers[0].setMap(map);
			//for (i in characters) {
			for (var i = 0; i < students.length; i++) {
				markers[markers.length] = new google.maps.Marker({
					position: students[i]['location'],
					map: map,
					title: students[i]['name']
				});
				//console.log(characters[i]['location']);
				
			}
			
			for (var j = 0; j < characters.length; j++) {
				markers[markers.length] = new google.maps.Marker({
					position: characters[j]['location'],
					map: map,
					title: characters[j]['name'],
					icon: 'icons/' + characters[j]['name'] + '.png'
				});
			}
			
			for (var k = 0; k < markers.length; k++) {
				markers[k].setMap(map);

/*
				google.maps.event.addListener(markers[k], 'click', function() {
					var infowindow = new google.maps.InfoWindow();
					infowindow.setContent(markers[k]['title']);
					infowindow.open(map, marker);
				});

*/
				infowindows[k] = new google.maps.InfoWindow();
				infowindows[k].setContent(markers[k]['title']);

				google.maps.event.addListener(markers[k], 'click', function() {
						infowindows[k].open(map, markers[k]);
				});



			}


			


		}









		function getCharacters(data) {
			for (i in data.characters){
				var cname = data['characters'][i]['name'];
				var clat = data['characters'][i]['loc']['latitude'];
				var clng = data['characters'][i]['loc']['longitude'];
				var cnote = data['characters'][i]['loc']['note'];
				var location = new google.maps.LatLng(clat, clng);
				var newchar = {name: cname, location: location, note: cnote};
				characters[characters.length] = newchar;
			}
		}

		function getStudents(data) {
			for (i in data.students){
				var sname = data['students'][i]['login'];
				var slat = data['students'][i]['lat'];
				var slng = data['students'][i]['lng'];
			//	var snote = jsonResponse['students'][i]['loc']['note'];
				var location = new google.maps.LatLng(slat, slng);
				var newstud = {name: sname, location: location};
				students[students.length] = newstud;
			}
		}

		xhr.open("POST", "http://chickenofthesea.herokuapp.com/sendLocation", true);
		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhr.send("login=SeamusFinnigan&lat="+lat+"&lng="+lng);


	</script>
</head>
<body>
	<div id = "map-canvas"></div>
</body>
</html>
